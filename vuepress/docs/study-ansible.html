<!DOCTYPE html>
<html lang="ja-JP">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Documents置き場 | 勉強会 - Ansible編</title>
    <meta name="description" content="社内用（仮）">
    <link rel="icon" href="/logo.png">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#3eaf7c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon-152x152.png">
  <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#3eaf7c">
  <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
  <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/assets/css/0.styles.020b7a50.css" as="style"><link rel="preload" href="/assets/js/app.96c895eb.js" as="script"><link rel="preload" href="/assets/js/10.f58e7bc8.js" as="script"><link rel="prefetch" href="/assets/js/12.e4d7d79f.js"><link rel="prefetch" href="/assets/js/1.2901b77d.js"><link rel="prefetch" href="/assets/js/2.fe279c4e.js"><link rel="prefetch" href="/assets/js/3.a1e5a722.js"><link rel="prefetch" href="/assets/js/4.c717642b.js"><link rel="prefetch" href="/assets/js/5.f1bae9ef.js"><link rel="prefetch" href="/assets/js/6.117a10d3.js"><link rel="prefetch" href="/assets/js/7.30727b3e.js"><link rel="prefetch" href="/assets/js/8.e109f9ca.js"><link rel="prefetch" href="/assets/js/9.1cca5ab7.js"><link rel="prefetch" href="/assets/js/11.ddc20257.js"><link rel="prefetch" href="/assets/js/13.3f80fabf.js"><link rel="prefetch" href="/assets/js/14.790aec29.js"><link rel="prefetch" href="/assets/js/15.8c72018f.js"><link rel="prefetch" href="/assets/js/16.181b4319.js"><link rel="prefetch" href="/assets/js/17.b933f83b.js"><link rel="prefetch" href="/assets/js/18.7f8088b1.js"><link rel="prefetch" href="/assets/js/19.be073bd4.js"><link rel="prefetch" href="/assets/js/20.815d6da1.js"><link rel="prefetch" href="/assets/js/21.9bf3f7eb.js"><link rel="prefetch" href="/assets/js/22.020b2cb4.js"><link rel="prefetch" href="/assets/js/23.fd42095d.js"><link rel="prefetch" href="/assets/js/24.5e64d509.js"><link rel="prefetch" href="/assets/js/25.916dabd0.js">
    <link rel="stylesheet" href="/assets/css/0.styles.020b7a50.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/" class="home-link router-link-active"><!----><span class="site-name">
      Documents置き場
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/docs/" class="nav-link router-link-active">Documents</a></div><div class="nav-item"><a href="/demo/" class="nav-link">DEMO</a></div><div class="nav-item"><a href="/guide/" class="nav-link">ガイド</a></div><a href="https://github.com/uuki/note" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/docs/" class="nav-link router-link-active">Documents</a></div><div class="nav-item"><a href="/demo/" class="nav-link">DEMO</a></div><div class="nav-item"><a href="/guide/" class="nav-link">ガイド</a></div><a href="https://github.com/uuki/note" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav><div class="carbon-ads"></div><!----></div><div class="page"><div class="content"><h1 id="勉強会-ansible編"><a href="#勉強会-ansible編" aria-hidden="true" class="header-anchor">#</a> 勉強会 - Ansible編</h1><h2 id="ansibleとは"><a href="#ansibleとは" aria-hidden="true" class="header-anchor">#</a> Ansibleとは</h2><p>環境構成ツールです。</p><p>一例として、サーバーの設定をAnsibleで行う場合に、<br>
主な環境としてはLAMPが有名ですが、<br>
手動で行っていたこれら（OS、Apache、MySQL、PHP）のインストールから設定までを、<br>
全て自動で行えるのがAnsibleです。</p><p>Ansibleの仕組みとしては「A」にAnsible本体をインストールして、<br>
「B」に対して実行する、といった処理を基本とします。</p><p>例えば、「自身のPC」から、「AWS等のクラウドサービス」に設定を展開するといった事です。</p><p>この時に、「B（実行対象）」にAnsibleを事前インストールしておく必要はありません。</p><hr><h2 id="ansibleの構成"><a href="#ansibleの構成" aria-hidden="true" class="header-anchor">#</a> Ansibleの構成</h2><p>次に、Ansibleの構成についてです。</p><p>Ansibleを実行するためには、最小構成でこれら4種類のファイルが必要になります。</p><p>inventory：<strong>接続先情報</strong><br>
playbook：<strong>実行ファイル</strong><br>
roles：<strong>処理内容</strong><br>
host_vars、group_vars：<strong>変数管理</strong></p><p>以降、各ファイルについて詳しく記載します。</p><hr><h2 id="intventory（インベントリ）"><a href="#intventory（インベントリ）" aria-hidden="true" class="header-anchor">#</a> Intventory（インベントリ）</h2><p>まず、<strong>インベントリ</strong>の説明です。</p><p><strong>インベントリファイル</strong>は、<strong>接続先情報</strong>を記録する、アドレス帳のような物です。</p><p>ここに「実行対象のマシン」のIPアドレス（住所）を記載する事で、  Ansibleを実行した時に、指定されているマシンに対して、処理を実行します。</p><p>コードは、以下の形を1セットとして記述します。<br>
これを正式名称「<strong>グループ変数</strong>」と呼びます。</p><div class="language- extra-class"><pre class="language-text"><code>[server-name]
192.168.X.X
</code></pre></div><hr><h2 id="varsとrole（バーズ、ロール）"><a href="#varsとrole（バーズ、ロール）" aria-hidden="true" class="header-anchor">#</a> varsとrole（バーズ、ロール）</h2><p>次に、<strong>各バーズファイル</strong>の説明です。</p><p><strong>バーズファイル</strong>は、<strong>変数</strong>を扱います。<br>
ロールは、バーズ側に定義された変数を組み込む事で、汎用性を持たせる事ができます</p><p>バーズファイルは、以下の２種類があります。</p><p><strong>host_vars</strong><br><strong>group_vars</strong></p><p>どちらも変数を扱うファイルですが、それぞれの意味合いとしては、環境毎に設定内容を分割する目的で使います。</p><p>例えば一般的な例として、基本の（ベースとなる）変数は<strong>host_vars</strong>に記載しておき、プロジェクト毎に一部値を変更するといった場合は、<strong>group_vars</strong>に管理しているファイルで基本の変数を上書きしていくといった仕組みです。</p><p>具体的な例をあげると、<strong>group_vars</strong>ディレクトリ以下に、プロジェクト名に対応した以下の様なフォルダを作成します。</p><div class="language- extra-class"><pre class="language-text"><code>group_vars/webserver1  
group_vars/webserver2
</code></pre></div><p>このように「環境=フォルダ単位」とする事で各フォルダ以下に、「<strong>任意の名前.yml</strong>」を作成して、設定を分岐させるといった事が可能です。</p><p>実際の記述はこのようになります。</p><div class="language- extra-class"><pre class="language-text"><code>---
user:
  name: vagrant
  group: vagrant
  password: vagrant

project: hoge
hostname: hoge.local
project_root: &quot;/home/
::: v-pre
`{{ user['name'] }}`
:::&quot;
document_root: &quot;
::: v-pre
`{{ project_root }}`
:::/www/html&quot;
log_root: /var/log
charset: utf8

mysql:
  dbname: fuga
  host: localhost
  root_password: foofoo
</code></pre></div><hr><p>続けて、<strong>ロール</strong>の説明です。</p><p>ロールには実際に走らせる処理（<strong>タスク</strong>）を記載します。<br>
以下のようなディレクトリ構成が１セットで、タスク処理は、ymlファイルに記述します。</p><div class="language- extra-class"><pre class="language-text"><code>roles/role-name/tasks/main.yml
</code></pre></div><p>「<strong>role-name</strong>」となっている箇所は、任意で命名します。基本的には「何を処理する物か」が分かりやすい名前で管理します。</p><p>具体的な例では、「wordpressをインストールする物」であれば、「wordpress」や、<br>
「wp」と命名するのがベターです。</p><p>タスク処理のよくある使用例としては、パッケージ管理コマンドの「yum」を使い、パッケージをインストールをさせるか、<br>
Linuxコマンドの、「cp（コピー）」や「mv（移動・リネーム）」といったシェルコマンドを直接実行させて、処理するといった形になります。</p><p>実際の使用例を１つあげると、Ansibleは独自メソッドとして「<strong>get_url</strong>」という処理を持っています。</p><p>これは、「引数にURLを指定して、対象を取得する」という用途のメソッドです。（Linux系の、「<strong>curl</strong>」や、「<strong>wget</strong>」と同じような認識で問題ありません）</p><p>以下は、「<strong>get_url</strong>」を使用して「Wordpress本体をダウンロード」している例です。</p><div class="language- extra-class"><pre class="language-text"><code>- name: WordPressの最新版をダウンロード
  get_url:
    url: https://ja.wordpress.org/latest-ja.tar.gz
    dest: &quot;/home/vagrant/www/html/wp.tar.gz&quot;
</code></pre></div><hr><h2 id="roleのtemplate機能（テンプレート）"><a href="#roleのtemplate機能（テンプレート）" aria-hidden="true" class="header-anchor">#</a> roleのtemplate機能（テンプレート）</h2><p>ロール（<strong>タスク</strong>）について、もう少し詳しく見ていきます。
ロールは、<strong>タスク</strong>の他に、<strong>テンプレート</strong>という機能も持っています。</p><p>テンプレート機能を使う場合は、以下のように管理名ディレクトリの下層に、<strong>templatesフォルダ</strong>を作成して、<strong>.j2（jinja2）形式のファイル</strong>を作成して記述します。</p><div class="language- extra-class"><pre class="language-text"><code>roles/管理名/templates/example.j2
</code></pre></div><p>templateは共通設定をしつつ、一部を変数で処理するための物です。
１つ前のロールの説明でWordpressをダウンロードする処理を書いていますが、インストールも自動で行いたい場合、設定ファイルの記述をなるべくプロジェクトに依存しない形で、使い回したいと思うはずです。</p><p>実際に、<strong>wp-config.php</strong>を設定した場合のコードを見てみます。</p><div class="language- extra-class"><pre class="language-text"><code>// ** MySQL 設定 - この情報はホスティング先から入手してください。 ** //
/** WordPress のためのデータベース名 */
define('DB_NAME', '
::: v-pre
`{{ mysql[&quot;dbname&quot;] }}`
:::');

/** MySQL データベースのユーザー名 */
define('DB_USER', '
::: v-pre
`{{ user[&quot;name&quot;] }}`
:::');

/** MySQL データベースのパスワード */
define('DB_PASSWORD', '
::: v-pre
`{{ user[&quot;password&quot;] }}`
:::');
</code></pre></div><p>「中カッコで記載している箇所**</p><div><p><code>{{ ~~~ }}</code>
::😗*」が変数になります。</p><p>ここで記載している3種類は、「各バーズファイルの説明」の項目で記載していた、以下の部分を読み込んでいます。</p><div class="language- extra-class"><pre v-pre class="language-text"><code>user:
  name: vagrant
  password: vagrant
</code></pre></div><div class="language- extra-class"><pre v-pre class="language-text"><code>mysql:
  dbname: fuga
  root_password: foofoo
</code></pre></div><p>この変数を、「各バーズファイルの説明」の項目に書いたように、環境別に管理しておき、これから説明するプレイブックで読み込む形で使用します。</p><p>以上が、ロールの基本的な使い方です。</p><hr><h2 id="playbookとinventory（プレイブック、インベントリ）"><a class="header-anchor" href="#playbookとinventory（プレイブック、インベントリ）" aria-hidden="true">#</a> playbookとinventory（プレイブック、インベントリ）</h2><p>最後に、プレイブックの説明です。<br>
プレイブックは、走らせるロールをを指定します。</p><p>プレイブックは以下のように記述します。</p><div class="language- extra-class"><pre v-pre class="language-text"><code>---
- name: プレイブック名
  hosts: server-name
  become: yes
  vars_files:
    - host_vars/example.yml
  roles:
    - ../roles/example-task1
    - ../roles/example-task2
    - ../roles/example-task3
</code></pre></div><p>上から説明します。</p><h3 id="name"><a class="header-anchor" href="#name" aria-hidden="true">#</a> name</h3><p>任意で付ける箇所です。<br>
一般的にAnsibleで行う一連の処理が分かる名前ような名前を付けます。</p><p>例えば、「LAMP環境を構築」などです。</p><h3 id="hosts"><a class="header-anchor" href="#hosts" aria-hidden="true">#</a> hosts</h3><p>インベントリに記載されている項目を指定する事で、
その宛先（マシン）に向けて、処理を実行します。</p><p>上記プレイブックでは、先ほどインベントリに記述していたこの項目を読み込んでいます。</p><div class="language- extra-class"><pre v-pre class="language-text"><code>[server-name]
192.168.X.X
</code></pre></div><h3 id="become"><a class="header-anchor" href="#become" aria-hidden="true">#</a> become</h3><p>Ansible版のsudoコマンドです。
引数にyesを指定する事で、role処理の全てをスーパーユーザー権限で行います。</p><h3 id="vars-files"><a class="header-anchor" href="#vars-files" aria-hidden="true">#</a> vars_files</h3><p>rolesに読ませる変数になります。
環境毎に分けていれば、この部分を変えるだけで適応できるため、プレイブックの調整だけで複数台の処理にあてられます。</p><h3 id="roles"><a class="header-anchor" href="#roles" aria-hidden="true">#</a> roles</h3><p>ここに記載した処理（role）が、実行されます。</p><p>例えば、「wordpressのダウンロード」処理と、「データベースの構築」処理は密接ですが、分割しておけば、それぞれを別のプロジェクトでも細かく使い回せます。</p><p>role処理は、スクラッチで作るのはコストがかかりますが、一度作ってしまえばどのようにも使いまわせる資産になるので、roleが溜まるほど様々な処理に対応できるようになり、コスト削減に繋がります。</p></div></div><div class="content edit-link"><a href="https://github.com/uuki/note/edit/master/docs/docs/study-ansible.md" target="_blank" rel="noopener noreferrer">Edit this page on GitHub</a><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><div class="last-updated"><span class="prefix">最終更新: </span><span class="time">2018-5-21 12:25:46</span></div></div><!----><div class="bsa-cpc-wrapper"><div class="bsa-cpc"></div></div></div></div></div>
    <script src="/assets/js/10.f58e7bc8.js" defer></script><script src="/assets/js/app.96c895eb.js" defer></script>
  </body>
</html>
