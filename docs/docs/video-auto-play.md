# Google Chrome 66 自動再生ポリシーについて

## 概要

こちらは、Google Chrome v66.0.3359.117（2018年4月17日〜）で変更された自動再生ポリシーについてのドキュメントです。

---

## 変更内容について

サイトを開いた瞬間にメディアが大音量で再生される事を避けるため、
音声付きの動画が、自動再生されなくなった。

変更後からは、videoタグの`autoplay`属性が付与されている場合や、
API経由であれば再生に関するメソッドが実行される場合、強制的に一時停止状態にされる。

なお、ポリシーにホワイトリストが設けられており、一部サイトにおいては自動再生が許可されているよう。
ざっくり下記のような仕様となっている。

- 判断元としているデータは、「Chromeが取得したユーザーの閲覧履歴」
- 閲覧履歴がないユーザーは、ブラウザにデフォルトでセットされている「自動再生が許可される比率が高い1000以上のサイト」のみ音声の自動再生を許可し、それ以外のサイトは無音化される。
- 上記の判定はグーグルが基準にしている「6秒ルール」に基づく。6秒ルールとは、ユーザーの行動データ的に自動音声再生サイトの多くが、ユーザーが不快と感じた場合「6秒以内に、一時停止、ミュート、タブを閉じる」のいずれかの操作が行われており、これをベースに判断されているらしい。

---

## 検証

ざっくり下記のような形になっている。

- 動画データ自体の音声の有無は無関係（「音声無し」でも、コード側でミュート指定でなければ自動再生されない）
- 同一ページ内に複数の動画データをロードしていて、１つでも「音声あり」の状態の物があると、他の動画も自動再生されない
- 実装方法（`video`、`iframe`）に関係なく、ミュート指定が存在すれば自動再生が可能
- Developer Toolsを開いている状態だと挙動が変わる（？）
---

## <a name="conclusion">対策</a>

自動再生が許可される条件は下記の通りです。

[デモ](http://docs.cinra.net/demo/#chrome-v66-%E8%87%AA%E5%8B%95%E5%86%8D%E7%94%9F%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB)

### HTML5 videoタグの場合

`muted` 属性を付加する。

例:

```html
<video muted autoplay="autoplay">
  <source src="xxx"></video>
</video>

```

### youtubeの場合（2018/5/15時点）

#### ~~パラメータ対応~~

対応不可

#### API

再生前に `myVideo.mute()` とする

### その他サービスの場合

提供されている機能の中に「消音化」するものがあれば、それで対応する。

---

ポリシー変更から約一ヶ月後（5月16日）、再度[告知](https://www.engadget.com/2018/05/16/google-chrome-66-muting-autoplay-rollback/)があり、「WebオーディオAPI」の自動再生ポリシーのみ、ロールバック（66.0.3359.181）するとの発表が行われています。

ただし、10月にリリース予定のChrome 70ではWebオーディオAPI含め自動再生ポリシーを復活させる予定との事で、
期限内に対応が必要な形です。

---

## 参考リンク

- [Safari, Chromeの自動再生ポリシー変更のまとめ](https://qiita.com/ktknest/items/e81b3a4caac540098fc8)
- [突然の音声事故を「6秒ルール」で低減。GoogleがPC/Mac版Chrome 66の音声自動ブロックを解説](https://japanese.engadget.com/2018/05/05/6-google-pc-mac-chrome-66/)
- [Improving Autoplay in Chrome - Google Blog](https://blog.google/products/chrome/improving-autoplay-chrome/)