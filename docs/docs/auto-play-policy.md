# ブラウザ毎の自動再生ポリシーについて

## 概要

こちらは、Google Chrome v66.0.3359.117（2018年4月17日〜）の自動再生ポリシーの変更に伴って調査したドキュメントです。

---

## 変更内容について

### Google Chrome

サイト訪問時に広告などのメディアが自動で流れ、ユーザーが不快と感じる事を減らすため、
音声付きのメディアが、自動再生されなくなりました。

変更後からは基本的に、音声つきのメディアに自動再生が指定されている場合、強制的に一時停止状態となります。
動画であればvideoタグの`autoplay`属性が付与されている場合や、API経由であれば再生に関するメソッドが実行される場合など。

ちなみにポリシー自体は少し前のバージョンから存在しており、「chrome://flags/#autoplay-policy」でオプションの確認ができます。

- Default （自動再生を許可）
- No user gesture is required. （ユーザージェスチャー不要）
- User gesture is required for cross-origin iframes. （originが異なるiframeのみ、ユーザージェスチャーを必要とする）
- Document user activation is required.（…？）

今回のアップデート（v66）では、Default が自動再生にユーザージェスチャーが必要となった形です。

なお、ポリシーにホワイトリストが設けられていて、一部サイトにおいては自動再生が許可されているようです。
ざっくり下記のような仕様となっています。

- 判断元としているデータは、「Chromeが取得したユーザーの閲覧履歴」
- 閲覧履歴がないユーザーは、ブラウザにデフォルトでセットされている「自動再生が許可される比率が高い1000以上のサイト」のみ音声の自動再生を許可し、それ以外のサイトは無音化される。
- 上記の判定はグーグルが基準にしている「6秒ルール」に基づく。6秒ルールとは、ユーザーの行動データ的に自動音声再生サイトの多くが、ユーザーが不快と感じた場合「6秒以内に、一時停止、ミュート、タブを閉じる」のいずれかの操作が行われており、これをベースに判断されているらしい。

デスクトップでは更に判断基準があるようで、詳しく書かれている記事（[Safari, Chromeの自動再生ポリシー変更のまとめ - Qiita](https://qiita.com/ktknest/items/e81b3a4caac540098fc8#chrome)）があります。

### Safari

Safari 11〜は、環境設定からサイト毎に自動再生を制御する事ができるようになっている他、
新たに実装された「省電力機能」によって、無音の動画がバックグラウンドのタブに移った場合や、オフスクリーンになっている場合に、自動再生をブロックします。

その他仕様については下記の通りです。

- 自動再生の制限は、要素ごとに付与される。複数の動画を連続して再生する（またはプレロール広告を音声で再生し、その後にメイン動画を再生する）場合は、複数のメディア要素を作成する代わりに、メディア要素のソースを変更します。
- メディアコントロールを表示せずに広告を再生しないでください。自動再生されない可能性があり、ユーザーは再生を開始できないためです。
- 無音を表現するオーディオトラックはまだオーディオトラックであり、その存在がビデオの自動再生の有無に影響します。このような場合、サイレントオーディオトラックのあるビデオは再生されません。オーディオトラックを削除するか、ミュートされた属性をメディア要素に設定することができます。


---

## 検証

とりあえず、ざっくり検証した結果です。

- 動画データ自体の音声の有無は無関係（「音声無し」でも、コード側でミュート指定でなければ自動再生されない）
- 同一ページ内に複数の動画データをロードしていて、１つでも「音声あり」の状態の物があると、他の動画も自動再生されない
- 実装方法（`video`、`iframe`）に関係なく、ミュート指定が存在すれば自動再生が可能
- Developer Toolsを開いている状態だと挙動が変わる（？）

---

## <a name="conclusion">対策</a>

自動再生が許可される条件は下記の通りです。

[デモ](http://docs.cinra.net/demo/#chrome-v66-%E8%87%AA%E5%8B%95%E5%86%8D%E7%94%9F%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB)

### HTML5 videoタグの場合

`muted` 属性を付加する。

例:

```html
<video muted autoplay="autoplay">
  <source src="xxx"></video>
</video>

```

### YouTubeの場合（2018/5/15時点）

#### ~~パラメータ対応~~

対応不可

#### API

再生前に `myVideo.mute()` とする

### その他サービスの場合

提供されている機能の中に「消音化」するものがあれば、それで対応する。

---

ポリシー変更から約一ヶ月後（5月16日）、再度[告知](https://www.engadget.com/2018/05/16/google-chrome-66-muting-autoplay-rollback/)があり、「WebオーディオAPI」の自動再生ポリシーのみ、ロールバック（66.0.3359.181）するとの発表が行われています。

ただし、10月にリリース予定のChrome 70ではWebオーディオAPI含め自動再生ポリシーを復活させる予定との事で、
期限内に対応が必要な形です。

---

## 参考リンク

- [Safari, Chromeの自動再生ポリシー変更のまとめ](https://qiita.com/ktknest/items/e81b3a4caac540098fc8)
- [Auto-Play Policy Changes for macOS](https://webkit.org/blog/7734/auto-play-policy-changes-for-macos/)
- [突然の音声事故を「6秒ルール」で低減。GoogleがPC/Mac版Chrome 66の音声自動ブロックを解説](https://japanese.engadget.com/2018/05/05/6-google-pc-mac-chrome-66/)
- [Improving Autoplay in Chrome - Google Blog](https://blog.google/products/chrome/improving-autoplay-chrome/)